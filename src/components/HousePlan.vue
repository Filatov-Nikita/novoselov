<template>
  <div class="tw-overflow-x-scroll app-scroll-x app-scroll-y tw-relative">
    <img class="tw-max-w-none lg:tw-mx-0" ref="img" width="2280" height="1080" src="@/assets/images/house-1.jpg" />
    <PopupTouchMove v-if="tappable && showTouchPopup" @hide="showTouchPopup = false"/>

    <svg ref="svg" class="tw-absolute tw-inset-0 lg:tw-mx-0" viewBox="0 0 2880 1080">
      <path d="M1327 162L1299.69 142.518C1298.31 141.519 1297.19 140.328 1296.31 138.944C1295.44 137.561 1295 136.024 1295 134.333L1295 85.9167C1295 84.0146 1295.67 82.3863 1297.01 81.0318C1298.36 79.6773 1299.97 79 1301.86 79L1352.14 79C1354.03 79 1355.64 79.6773 1356.99 81.0318C1358.33 82.3863 1359 84.0146 1359 85.9167L1359 134.333C1359 136.024 1358.56 137.561 1357.69 138.944C1356.81 140.328 1355.69 141.519 1354.31 142.518L1327 162Z" fill="#F5F5F5"/>
      <path d="M1310.68 96.3408L1311.89 96.498C1311.76 97.332 1311.42 97.986 1310.88 98.46C1310.33 98.9294 1309.67 99.1641 1308.87 99.1641C1307.88 99.1641 1307.08 98.8405 1306.47 98.1934C1305.87 97.5417 1305.57 96.6097 1305.57 95.3975C1305.57 94.6136 1305.7 93.9277 1305.96 93.3398C1306.22 92.752 1306.61 92.3122 1307.14 92.0205C1307.68 91.7243 1308.26 91.5762 1308.88 91.5762C1309.67 91.5762 1310.31 91.7767 1310.81 92.1777C1311.32 92.5742 1311.64 93.1393 1311.78 93.873L1310.58 94.0576C1310.47 93.57 1310.27 93.2031 1309.97 92.957C1309.69 92.7109 1309.34 92.5879 1308.93 92.5879C1308.31 92.5879 1307.8 92.8112 1307.42 93.2578C1307.03 93.6999 1306.84 94.4017 1306.84 95.3633C1306.84 96.3385 1307.02 97.0472 1307.4 97.4893C1307.77 97.9313 1308.26 98.1523 1308.86 98.1523C1309.34 98.1523 1309.75 98.0042 1310.07 97.708C1310.39 97.4118 1310.6 96.9561 1310.68 96.3408ZM1317.64 96.6621L1318.91 96.8193C1318.71 97.5622 1318.34 98.1387 1317.79 98.5488C1317.25 98.959 1316.56 99.1641 1315.72 99.1641C1314.65 99.1641 1313.81 98.8382 1313.19 98.1865C1312.57 97.5303 1312.26 96.612 1312.26 95.4316C1312.26 94.2103 1312.57 93.2624 1313.2 92.5879C1313.83 91.9134 1314.64 91.5762 1315.65 91.5762C1316.62 91.5762 1317.41 91.9066 1318.03 92.5674C1318.64 93.2282 1318.95 94.1579 1318.95 95.3564C1318.95 95.4294 1318.95 95.5387 1318.94 95.6846H1313.53C1313.57 96.4821 1313.8 97.0928 1314.21 97.5166C1314.61 97.9404 1315.12 98.1523 1315.72 98.1523C1316.17 98.1523 1316.56 98.0339 1316.88 97.7969C1317.2 97.5599 1317.45 97.1816 1317.64 96.6621ZM1313.6 94.6729H1317.65C1317.6 94.0622 1317.44 93.6042 1317.19 93.2988C1316.79 92.8249 1316.29 92.5879 1315.66 92.5879C1315.1 92.5879 1314.62 92.777 1314.23 93.1553C1313.85 93.5335 1313.64 94.0394 1313.6 94.6729ZM1320.17 91.7402H1321.4V94.8779C1321.8 94.8779 1322.07 94.8027 1322.22 94.6523C1322.38 94.502 1322.62 94.0645 1322.92 93.3398C1323.16 92.7656 1323.36 92.3874 1323.51 92.2051C1323.66 92.0228 1323.83 91.8997 1324.03 91.8359C1324.22 91.7721 1324.54 91.7402 1324.97 91.7402H1325.22V92.7588L1324.88 92.752C1324.55 92.752 1324.35 92.7998 1324.25 92.8955C1324.16 92.9958 1324.01 93.2943 1323.82 93.791C1323.63 94.265 1323.46 94.5931 1323.3 94.7754C1323.15 94.9577 1322.91 95.124 1322.59 95.2744C1323.11 95.4157 1323.63 95.9079 1324.14 96.751L1325.49 99H1324.14L1322.83 96.751C1322.56 96.2998 1322.32 96.0036 1322.12 95.8623C1321.92 95.7165 1321.68 95.6436 1321.4 95.6436V99H1320.17V91.7402ZM1326.05 91.7402H1327.28V97.9883H1330.68V91.7402H1331.91V97.9883H1332.7V101.058H1331.69V99H1326.05V91.7402ZM1333.77 91.7402H1335V97.2773L1338.41 91.7402H1339.74V99H1338.51V93.4971L1335.1 99H1333.77V91.7402ZM1347.03 91.7402V99H1345.8V96.1699H1345.09C1344.66 96.1699 1344.33 96.2269 1344.12 96.3408C1343.91 96.4502 1343.6 96.8079 1343.2 97.4141L1342.12 99H1340.6L1341.93 97.0449C1342.33 96.4479 1342.73 96.1107 1343.14 96.0332C1342.43 95.9375 1341.91 95.6846 1341.57 95.2744C1341.23 94.8643 1341.06 94.3926 1341.06 93.8594C1341.06 93.2305 1341.29 92.7201 1341.73 92.3281C1342.17 91.9362 1342.82 91.7402 1343.66 91.7402H1347.03ZM1345.8 92.7588H1344.05C1343.32 92.7588 1342.84 92.8727 1342.63 93.1006C1342.42 93.3285 1342.32 93.5951 1342.32 93.9004C1342.32 94.3333 1342.47 94.6523 1342.78 94.8574C1343.09 95.0579 1343.65 95.1582 1344.44 95.1582H1345.8V92.7588Z" fill="#9BA5B0"/>
      <path d="M1329.05 110.8H1330.42V136H1327.43V114.292L1321.63 116.632V113.68L1329.05 110.8Z" fill="#18283A"/>
      <path d="M1661 210L1633.69 190.518C1632.31 189.519 1631.19 188.328 1630.31 186.944C1629.44 185.561 1629 184.024 1629 182.333L1629 133.917C1629 132.015 1629.67 130.386 1631.01 129.032C1632.36 127.677 1633.97 127 1635.86 127L1686.14 127C1688.03 127 1689.64 127.677 1690.99 129.032C1692.33 130.386 1693 132.015 1693 133.917L1693 182.333C1693 184.024 1692.56 185.561 1691.69 186.944C1690.81 188.328 1689.69 189.519 1688.31 190.518L1661 210Z" fill="#F5F5F5"/>
      <path d="M1644.68 144.341L1645.89 144.498C1645.76 145.332 1645.42 145.986 1644.88 146.46C1644.33 146.929 1643.67 147.164 1642.87 147.164C1641.88 147.164 1641.08 146.84 1640.47 146.193C1639.87 145.542 1639.57 144.61 1639.57 143.397C1639.57 142.614 1639.7 141.928 1639.96 141.34C1640.22 140.752 1640.61 140.312 1641.14 140.021C1641.68 139.724 1642.26 139.576 1642.88 139.576C1643.67 139.576 1644.31 139.777 1644.81 140.178C1645.32 140.574 1645.64 141.139 1645.78 141.873L1644.58 142.058C1644.47 141.57 1644.27 141.203 1643.97 140.957C1643.69 140.711 1643.34 140.588 1642.93 140.588C1642.31 140.588 1641.8 140.811 1641.42 141.258C1641.03 141.7 1640.84 142.402 1640.84 143.363C1640.84 144.339 1641.02 145.047 1641.4 145.489C1641.77 145.931 1642.26 146.152 1642.86 146.152C1643.34 146.152 1643.75 146.004 1644.07 145.708C1644.39 145.412 1644.6 144.956 1644.68 144.341ZM1651.64 144.662L1652.91 144.819C1652.71 145.562 1652.34 146.139 1651.79 146.549C1651.25 146.959 1650.56 147.164 1649.72 147.164C1648.65 147.164 1647.81 146.838 1647.19 146.187C1646.57 145.53 1646.26 144.612 1646.26 143.432C1646.26 142.21 1646.57 141.262 1647.2 140.588C1647.83 139.913 1648.64 139.576 1649.65 139.576C1650.62 139.576 1651.41 139.907 1652.03 140.567C1652.64 141.228 1652.95 142.158 1652.95 143.356C1652.95 143.429 1652.95 143.539 1652.94 143.685H1647.53C1647.57 144.482 1647.8 145.093 1648.21 145.517C1648.61 145.94 1649.12 146.152 1649.72 146.152C1650.17 146.152 1650.56 146.034 1650.88 145.797C1651.2 145.56 1651.45 145.182 1651.64 144.662ZM1647.6 142.673H1651.65C1651.6 142.062 1651.44 141.604 1651.19 141.299C1650.79 140.825 1650.29 140.588 1649.66 140.588C1649.1 140.588 1648.62 140.777 1648.23 141.155C1647.85 141.534 1647.64 142.039 1647.6 142.673ZM1654.17 139.74H1655.4V142.878C1655.8 142.878 1656.07 142.803 1656.22 142.652C1656.38 142.502 1656.62 142.064 1656.92 141.34C1657.16 140.766 1657.36 140.387 1657.51 140.205C1657.66 140.023 1657.83 139.9 1658.03 139.836C1658.22 139.772 1658.54 139.74 1658.97 139.74H1659.22V140.759L1658.88 140.752C1658.55 140.752 1658.35 140.8 1658.25 140.896C1658.16 140.996 1658.01 141.294 1657.82 141.791C1657.63 142.265 1657.46 142.593 1657.3 142.775C1657.15 142.958 1656.91 143.124 1656.59 143.274C1657.11 143.416 1657.63 143.908 1658.14 144.751L1659.49 147H1658.14L1656.83 144.751C1656.56 144.3 1656.32 144.004 1656.12 143.862C1655.92 143.716 1655.68 143.644 1655.4 143.644V147H1654.17V139.74ZM1660.05 139.74H1661.28V145.988H1664.68V139.74H1665.91V145.988H1666.7V149.058H1665.69V147H1660.05V139.74ZM1667.77 139.74H1669V145.277L1672.41 139.74H1673.74V147H1672.51V141.497L1669.1 147H1667.77V139.74ZM1681.03 139.74V147H1679.8V144.17H1679.09C1678.66 144.17 1678.33 144.227 1678.12 144.341C1677.91 144.45 1677.6 144.808 1677.2 145.414L1676.12 147H1674.6L1675.93 145.045C1676.33 144.448 1676.73 144.111 1677.14 144.033C1676.43 143.938 1675.91 143.685 1675.57 143.274C1675.23 142.864 1675.06 142.393 1675.06 141.859C1675.06 141.23 1675.29 140.72 1675.73 140.328C1676.17 139.936 1676.82 139.74 1677.66 139.74H1681.03ZM1679.8 140.759H1678.05C1677.32 140.759 1676.84 140.873 1676.63 141.101C1676.42 141.328 1676.32 141.595 1676.32 141.9C1676.32 142.333 1676.47 142.652 1676.78 142.857C1677.09 143.058 1677.65 143.158 1678.44 143.158H1679.8V140.759Z" fill="#9BA5B0"/>
      <path d="M1670.44 181.12V184H1651.54V181.84L1658.85 175.468C1662.24 172.516 1664.4 170.5 1665.33 169.42C1666.29 168.34 1666.77 167.188 1666.77 165.964C1666.77 164.572 1666.26 163.444 1665.22 162.58C1664.19 161.692 1662.81 161.248 1661.08 161.248C1659.36 161.248 1657.96 161.716 1656.91 162.652C1655.85 163.564 1655.14 164.86 1654.78 166.54H1651.76C1652.12 164.044 1653.15 162.064 1654.86 160.6C1656.56 159.136 1658.68 158.404 1661.23 158.404C1663.77 158.404 1665.82 159.112 1667.38 160.528C1668.97 161.944 1669.76 163.72 1669.76 165.856C1669.76 167.584 1669.18 169.144 1668.03 170.536C1666.9 171.904 1664.66 174.04 1661.3 176.944L1656.48 181.12H1670.44Z" fill="#18283A"/>

      <path
        v-for="(path, i) in paths"
        :key="i"
        :d="path"
        fill="#FBB03B"
        :opacity="active === storeyId(i) ? 0.65 : 0"
        @click="onClick($event, storeyId(i))"
        @mouseenter="onEnter($event, storeyId(i))"
        @mouseleave="onLeave($event, storeyId(i))" />
      />
    </svg>
  </div>
</template>

<script>
import { throttle } from 'throttle-debounce';
import PopupTouchMove from './PopupTouchMove.vue'

export default {
  props: {
    height: {
      required: true,
      type: String,
    },
    width: {
      required: true,
      type: String,
    },
    activeStorey: {
      default: undefined,
    },
  },
  emits: ["enter", "leave"],
  components: {
    PopupTouchMove
  },
  mounted() {
    this.calcStyles();
    this.$refs.img.addEventListener('load', this.calcStyles);
    this.resizer = throttle(500, this.calcStyles);
    window.addEventListener('resize', this.resizer);
  },
  beforeUnmount() {
    window.removeEventListener('resize', this.resizer);
  },
  data() {
    return {
      showTouchPopup: true,
      active: null,
      resizer: null,
      paths1: [
        'M1035.5 163.001L864.5 189.501V155.5L1034.5 128.676L1517.5 224.001V252L1035.5 163.001Z',
        'M1035 218.5L867 239.5V206.5L1035 182.5L1517 270.501V300L1035 218.5Z',
        'M1035 269.5L864 292V257L1035 235L1517 313.5V341.5L1035 269.5Z',
        'M1036 322.5L866.5 342V306L1036 288L1518 358.5V387.5L1036 322.5Z',
        'M1033.5 376L864 392V356L1033.5 338L1518 402V432.5L1033.5 376Z',
        'M1034.5 426L865 442V406L1034.5 392L1519 447V476L1034.5 426Z',
        'M1033.5 479.5L864 493.5V459L1033.5 445L1518 490V519.5L1033.5 479.5Z',
        'M1034.5 532.5L865 542.5V508L1034.5 494L1519 534.5V565L1034.5 532.5Z',
        'M1033 585L864 592V556.5L1033 547L1517 579V608.5L1033 585Z',
        'M1034 637L866.5 643.5V609.797L1034 602.5L1517 623.5V654L1034 637Z',
        'M1034 691L865.5 695V660L1034 654L1516.5 667.5V695.5L1034 691Z',
        'M1034 743L867 744.5L868 710L1034 708L1516.5 711V743H1034Z',
        'M1033.5 793H866V758.5L1033.5 760.5L1518.5 756V784L1033.5 793Z',
        'M1033.5 847.5L867.5 845.5V811.5L1033.5 813.5L1516.5 799V830L1033.5 847.5Z',
        'M1034 902L868 897.5V860.5L1034 865.5L1517 845.5V874.5L1034 902Z',
        'M1034 956.5L868 949V912L1034 919.5L1517 889.5V921.5L1034 956.5Z',
        'M1033 1007L867 999.5V962.5L1033 970L1516 936V969L1033 1007Z',
        'M1033 1070L867 1065.5V1019.5L1033 1027L1516 988V1025.5L1033 1070Z',
      ],
      paths2: [
        'M1548 265.288V221L1751 255.781V298L1548 265.288Z',
        'M1548 309.288V267L1751 300V340.5L1548 309.288Z',
        'M1548 353.288V311L1751 342.5V382.5L1548 353.288Z',
        'M1548 396.288V354L1751 384.5V425L1548 396.288Z',
        'M1548 440.288V398L1751 426V465L1548 440.288Z',
        'M1548 486V442L1751 466.5V505.5L1548 486Z',
        'M1548 532V488L1751 507.5V545.5L1548 532Z',
        'M1548 577V533L1751 547V589L1548 577Z',
        'M1548 622V578L1751 590.5V629.5L1548 622Z',
        'M1548 667V623L1751 631V671.5L1548 667Z',
        'M1548 709.5V668L1751 673.5V714L1548 709.5Z',
        'M1548 756V712L1751 715.5V753.5L1548 756Z',
        'M1548 800V758L1751 756V795.5L1548 800Z',
        'M1548 844V802L1751 797V836L1548 844Z',
        'M1548 889V847L1751 838V878L1548 889Z',
        'M1548 933V891L1751 880V919.5L1548 933Z',
        'M1548 976V934L1751 921.5V962.5L1548 976Z',
      ]
    };
  },
  computed: {
    paths() {
      return  this.paths1.reverse().concat(this.paths2.reverse());
    },
    tappable() {
      return this.$screen.touch;
    },
  },
  methods: {
    storeyId(i) {
      return i + 1;
    },
    calcStyles() {
      const ratio = 2880 / 1080;
      const w = window.innerWidth;
      const h = window.innerHeight - 97 - 81;

      const w2 = ratio * h;

      if(w2 < w) {
        this.$refs.img.style.width = w + 'px';
        this.$refs.img.style.height = 'auto';
      } else {
        this.$refs.img.style.height = h + 'px';
        this.$refs.img.style.width = 'auto';
      }

      setTimeout(() => {
        const computed = getComputedStyle(this.$refs.img);
        this.$refs.svg.style.width = computed.width;
        this.$refs.svg.style.height = computed.height;
      }, 0);
    },
    onClick(e, id) {
      this.active = id;
      if (this.tappable && this.activeStorey?.id !== id) {
        return this.$emit("enter", id);
      }
      this.$router.push({ name: "storey", params: { id: id } });
    },
    onEnter(e, id) {
      if (!this.tappable) {
        this.active = id;
        return this.$emit("enter", id);
      }
    },
    onLeave(e, id) {
      if (!this.tappable) {
        this.active = null;
        return this.$emit("leave", id);
      }
    },
  },
};
</script>
